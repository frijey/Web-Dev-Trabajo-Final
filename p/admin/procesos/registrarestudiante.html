<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <title>Administrador</title>
</head>
<body>
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <a class="navbar-brand" href="#">Centro Educativo Tesla</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Inicio</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link" href="../nosotros.html">Nosotros</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" id="navbarDropdown" data-toggle="dropdown">Procesos</a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item text-primary" href="">Registrar Estudiantes</a>
                            <a class="dropdown-item text-primary" href="noticias.html">Configuración</a>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../contacto.html">Contacto</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="CerrarSesion();" href="../../../index.html">Salir</a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="jumbotron">
            <div class="main row">
                <div class="col-sm-12">
                    <center><h3 class="text-yellow">Registrar Estudiante</h3></center> <br />
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-3 col-lg-3 " align="center">
                                <img src="../../../pics/profile.png" class="img-circle img-fluid img-responsive" id="imgestudiante"> <br /><br />
                                <input type="file" id="selectedFile" style="display: none;" accept=".jpg" />
                                <input class="btn btn-warning" type="button" value="Cargar Imagen" onclick="document.getElementById('selectedFile').click();" />
                                <br />
                                <br />
                                <input class="form-control" type="text" value="" id="rutafoto" placeholder="Ruta foto" disabled>
                                <br />
                                <br />
                            </div>

                            <div class=" col-md-9 col-lg-9 ">
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Nombre</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="" id="nombreest" placeholder="nombre">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Apellido</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="" id="apellidoest" placeholder="apellido">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-10">
                                        <label for="exampleSelect1">Género</label>
                                        <select class="form-control" id="generoest">
                                            <option>Masculino</option>
                                            <option>Femenino</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-date-input" class="col-12 col-form-label">Fecha de Nacimiento</label>
                                    <div class="col-10">
                                        <input class="form-control" type="date" value="" id="fechanac">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-10">
                                        <label for="exampleSelect1">Curso</label>
                                        <select class="form-control" id="cursoest">
                                            <option></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Nombre del Papá</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="" id="nombrepadre" placeholder="nomb. padre">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Nombre de la Mamá</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="" id="nombremadre" placeholder="nomb. madre">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Teléfono</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="809-000-0000" id="telest" placeholder="teléfono">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Email</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="" id="newemail" placeholder="email@dominio.com">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Contraseña</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="123456" id="newpass" placeholder="contraseña">
                                    </div>
                                </div>
                                <a onclick="this.className = 'btn btn-success active disabled'; Registrar();" class="btn btn-success active" id="registrarbtn">Registrar</a>
                                <a onclick="window.location.reload()" class="btn btn-danger active">Cancelar</a>
                                <a onclick="" class="btn btn-info active">Modificar</a>
                                <br />
                                <br />
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer>
            <div class="container-fluid bg-primary">
                <h3 class="text-white lead">Galvin Santos & Jeffry Marte B.</h3>
            </div>
        </footer>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <!-- Conexión con la base de datos -->
    <script src="https://www.gstatic.com/firebasejs/5.1.0/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyD0wEMTWqhJb9Q_fawATAEakx3gQahjeAw",
            authDomain: "controldecalificaciones.firebaseapp.com",
            databaseURL: "https://controldecalificaciones.firebaseio.com",
            projectId: "controldecalificaciones",
            storageBucket: "controldecalificaciones.appspot.com",
            messagingSenderId: "24849732387"
        };
        firebase.initializeApp(config);
        const rootRef = firebase.database().ref();

        var secondaryApp = firebase.initializeApp(config, "Secondary");

        var btnregistrar = document.getElementById('registrarbtn');
        var actualphoto = document.getElementById('imgestudiante');
        var file = document.getElementById('selectedFile');
        var rutafoto = document.getElementById('rutafoto');
        var nombrest = document.getElementById('nombreest');
        var apellidoest = document.getElementById('apellidoest');
        var generoest = document.getElementById('generoest');
        var fechanac = document.getElementById('fechanac');
        var cursoest = document.getElementById('cursoest');
        var nombrepadre = document.getElementById('nombrepadre');
        var nombremadre = document.getElementById('nombremadre');
        var telest = document.getElementById('telest');

        var newemail = document.getElementById('newemail');
        var newpass = document.getElementById('newpass');

        var numeroest = '77';
        const auth = firebase.auth();
        var MyKey = '';
        var fotourl = actualphoto.src;
        var NewUserUid = 'TESTuid-asdasdasd';
        var ActualPeriodo = '';
        var dbRef = firebase.database().ref().child('ESTUDIANTES');
        var foundData = false;
        var CountEstudiantes = 1;
        var RolesCount = 1;
        var fileFrom;
        var ContadorEstudiantesCurso; //Contar cuantos estudiantes activos hay registrados en un curso...
        var test;

        file.addEventListener('change', function (e) {

            //Get file
            fileFrom = e.target.files[0];
            rutafoto.value = e.target.value;

            firebase.database().ref('CURSOS/' + cursoest.value + '/numero').once('value').then(function (snapshot) {
                if (snapshot != null) {
                    //Asignar el número buscado
                    numeroest = snapshot.val();
                } else {
                }
            });

        });

        cursoest.addEventListener('change', function (e) {

            firebase.database().ref('CURSOS/' + cursoest.value + '/numero').once('value').then(function (snapshot) {
                if (snapshot != null) {
                    //Asignar el número buscado
                    numeroest = snapshot.val();
                } else {
                }
            });

            //Leer el conteo de estudiantes en dicho curso
            rootRef.child('PERIODOESCOLAR').child(ActualPeriodo).child('CURSOS').child(cursoest.value).child('ESTUDIANTES').on('value', function (snapshot) {
                ContadorEstudiantesCurso = snapshot.child('count').val();
            });

        });

        function Registrar() {
            btnregistrar.className = 'btn btn-success active disabled';
            newemail.value = newemail.value.toLowerCase();

            //validar que ningún campo esté vacío...
            if (nombrest.value == "" || apellidoest.value == "" || generoest.value == "" || fechanac.value == "" || cursoest.value == "" ||
                nombrepadre.value == "" || nombremadre.value == "" || telest.value == "" || newemail.value == "" || newpass.value == "" || rutafoto.value == "") {
                alert('Rellene todos los campos y seleccione la foto del estudiante');
                btnregistrar.className = 'btn btn-success active';
                return;
            } else {
                //Continue
            }


            //const promise = secondaryApp.auth().createUserWithEmailAndPassword(newemail.value, newpass.value);
            //promise.catch(e => alert(e.message));

            secondaryApp.auth().createUserWithEmailAndPassword(newemail.value, newpass.value)
                .then(function () {
                })
                .then(function () {
                })
                .catch(function (error) {
                    alert(error.message);
                    btnregistrar.className = 'btn btn-success active';
                });

            //NewUserUid = firebaseUser.user.uid;
            //console.log(NewUserUid)
            //secondaryApp.auth().signOut();

        }


        secondaryApp.auth().onAuthStateChanged((user) => {
            if (user) {

                NewUserUid = user.uid;
                console.log(NewUserUid)

                //Agregar datos de acceso a la DB
                rootRef.child('PASSWORDS/' + NewUserUid).set({
                    nombre: nombrest.value + ' ' + apellidoest.value,
                    pass: newpass.value,
                    uid: NewUserUid
                });

                var sumador;
                //Sumar uno a la cantidad de count
                rootRef.child('PASSWORDS').child('count').once('value', function (snapshot){
                    sumador = snapshot.val()
                    console.log('count de PASSWORDS: '+sumador)

                    rootRef.child('PASSWORDS/').update({
                        count: (sumador + 1)
                    });
                });

                //Leer el conteo de estudiantes en dicho curso
                rootRef.child('PERIODOESCOLAR').child(ActualPeriodo).child('CURSOS').child(cursoest.value).child('ESTUDIANTES').on('value', function (snapshot) {
                    ContadorEstudiantesCurso = snapshot.child('count').val();
                    console.log(ContadorEstudiantesCurso);
                });

                conseguirNumero();
                ProcesoDeRegistro();
                secondaryApp.auth().signOut();
            } else {
            }
        });



        rootRef.child('ESTUDIANTES').child('count').on('value', function (snapshot) {
            CountEstudiantes = snapshot.val();
            console.log(CountEstudiantes);
        });

        rootRef.child('ROLES').child('count').on('value', function (snapshot) {
            RolesCount = snapshot.val();
            console.log(CountEstudiantes);
        });

        rootRef.child('CURSOS').on('value', function (snapshot) {

            //Vaciar DropDown
            cursoest.options.length = 0;

            //Llenar el Dropdown
            var scores = snapshot.val();
            var Keys = Object.keys(scores);

            for (var i = 0; i < (Keys.length - 1); i++) {
                var opt = snapshot.child(Keys[i]).child('nombre').val();
                var optvalue = Keys[i];
                var el = document.createElement("option");
                el.textContent = opt;
                el.value = optvalue;
                cursoest.appendChild(el);
            }

        });

        rootRef.child('periodoactual').on('value', function (snapshot) {
            ActualPeriodo = snapshot.val();
            console.log(ActualPeriodo);
        });

        function conseguirNumero() {
            firebase.database().ref('CURSOS/' + cursoest.value + '/numero').once('value').then(function (snapshot) {
                if (snapshot != null) {
                    //Asignar el número buscado
                    numeroest = snapshot.val();
                    console.log(numeroest);
                    //numeroest = numeroest.child('numero').val();

                    //Aumentar uno al número
                    firebase.database().ref('CURSOS/' + cursoest.value + '/').set({
                        numero: (numeroest + 1),
                        estado: 'ACTIVO',
                    });

                } else {
                }
            });
        }

        function ProcesoDeRegistro() {

            //Guardar datos en ESTUDIANTES
            firebase.database().ref('ESTUDIANTES/' + NewUserUid).set({
                nombre: nombrest.value,
                apellido: apellidoest.value,
                genero: generoest.value,
                fechanac: fechanac.value,
                curso: cursoest.value,
                PERIODO: {
                    PERIODOSCURSADOS: {
                        [ActualPeriodo]: {
                            curso: cursoest.value,
                            numero: numeroest,
                        },
                    },
                },
                nombrepadre: nombrepadre.value,
                nombremadre: nombremadre.value,
                telefono: telest.value,
                email: newemail.value,
                uid: NewUserUid,
                foto: 'fotos/' + NewUserUid + '.jpg'

            });

            //Aumentar uno al número
            firebase.database().ref('ESTUDIANTES/').update({
                count: (CountEstudiantes + 1),
            });

            firebase.database().ref('ROLES/' + NewUserUid).set({
                rol: 'est'
            });

            //Aumentar uno al número
            firebase.database().ref('ROLES/').update({
                count: (RolesCount + 1),
            });

            console.log(ContadorEstudiantesCurso);
            //Aumentar uno al número
            firebase.database().ref('PERIODOESCOLAR/' + ActualPeriodo + '/CURSOS/' + cursoest.value + '/ESTUDIANTES/').update({
                count: (ContadorEstudiantesCurso + 1),
            });
            console.log(ContadorEstudiantesCurso);

            //Anotar Estudiante en el curso
            test = {
                [numeroest]: {
                    nombre: (nombrest.value + ' ' + apellidoest.value),
                    numero: numeroest,
                    uid: NewUserUid
                },
            };
            console.log(test);

            firebase.database().ref('PERIODOESCOLAR/' + ActualPeriodo + '/CURSOS/' + cursoest.value + '/ESTUDIANTES/').update({
                //[NewUserUid]: nombrest.value+' '+apellidoest.value, //Descontinuado
                [numeroest]: {
                    nombre: (nombrest.value + ' ' + apellidoest.value),
                    numero: numeroest,
                    uid: NewUserUid
                },
            });

            //Upload the profile picture
            //Create storage ref
            var storageref = firebase.storage().ref('fotos/' + NewUserUid + '.jpg');

            //Upload file
            var task = storageref.put(fileFrom);

            task.on('state_changed', function progress(snapshot) {

            }, function error(err) {
                alert('Hubo un error al subir la foto a la nube');
            }, function complete() {
                window.scrollTo(0, 0);
                //window.location.reload();
            })

        }

        function errData(err) {
            console.log('¡Error!');
            console.log(err);
        }

        auth.onAuthStateChanged(firebaseUser => {
            if (firebaseUser) {
                console.log(firebaseUser);
            } else {
                console.log('Sesión Cerrada');
                CerrarSesion();
            }
        });

        function CerrarSesion() {
            firebase.auth().signOut();
            window.location = '../../../index.html';
        }

    </script>
</body>
</html>