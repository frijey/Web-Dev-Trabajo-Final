<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <title>Administrador</title>
</head>
<body>
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <a class="navbar-brand" href="#">Centro Educativo Tesla</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Inicio</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link" href="../nosotros.html">Nosotros</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" id="navbarDropdown" data-toggle="dropdown">Procesos</a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item text-primary" href="registrarestudiante.html">Registro de Estudiantes</a>
                            <a class="dropdown-item text-primary" href="registrarprofesores.html">Registro de Profesores</a>
                            <a class="dropdown-item text-primary" href="lista de estudiantes.html">Listas</a>
                            <a class="dropdown-item text-primary" href="materias.html">Materias</a>
                            <a class="dropdown-item text-primary" href="noticias.html">Configuración</a>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../contacto.html">Contacto</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="CerrarSesion();" href="../../../index.html">Salir</a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="jumbotron">
            <div class="main row">
                <div class="col-sm-12">
                    <center><h3 class="text-yellow">Registrar Profesor</h3></center> <br />
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-3 col-lg-3 " align="center">
                                <img src="../../../pics/profile.png" class="img-circle img-fluid img-responsive" id="imgestudiante"> <br /><br />
                                <input type="file" id="selectedFile" style="display: none;" accept=".jpg" />
                                <input class="btn btn-warning" type="button" value="Cargar Imagen" onclick="document.getElementById('selectedFile').click();" />
                                <br />
                                <br />
                                <input class="form-control" type="text" value="" id="rutafoto" placeholder="Ruta foto" disabled>
                                <br />
                                <br />
                            </div>

                            <div class=" col-md-9 col-lg-9 ">
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Nombre</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="" id="nombreprof" placeholder="nombre">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Apellido</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="" id="apellidoprof" placeholder="apellido">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-10">
                                        <label for="exampleSelect1">Género</label>
                                        <select class="form-control" id="generoprof">
                                            <option>Masculino</option>
                                            <option>Femenino</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-date-input" class="col-12 col-form-label">Fecha de Nacimiento</label>
                                    <div class="col-10">
                                        <input class="form-control" type="date" value="" id="fechanac">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-date-input" class="col-12 col-form-label">Fecha de Inicio Laboral</label>
                                    <div class="col-10">
                                        <input class="form-control" type="date" value="" id="fechainicio">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Cédula o ID</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="" id="cedulaid" placeholder="Identificación">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Teléfono</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="809-000-0000" id="telprof" placeholder="teléfono">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Email</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="" id="newemail" placeholder="email@dominio.com">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="example-text-input" class="col-12 col-form-label">Contraseña</label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" value="1234567" id="newpass" placeholder="contraseña">
                                    </div>
                                </div>
                                <a onclick="this.className = 'btn btn-success active disabled'; Registrar();" class="btn btn-success active" id="registrarbtn">Registrar</a>
                                <a onclick="window.location.reload()" class="btn btn-danger active">Cancelar</a>
                                <a onclick="" class="btn btn-info active">Modificar</a>
                                <br />
                                <br />
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer>
            <div class="container-fluid bg-primary">
                <h3 class="text-white lead">Galvin Santos & Jeffry Marte B.</h3>
            </div>
        </footer>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <!-- Conexión con la base de datos -->
    <script src="https://www.gstatic.com/firebasejs/5.1.0/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyD0wEMTWqhJb9Q_fawATAEakx3gQahjeAw",
            authDomain: "controldecalificaciones.firebaseapp.com",
            databaseURL: "https://controldecalificaciones.firebaseio.com",
            projectId: "controldecalificaciones",
            storageBucket: "controldecalificaciones.appspot.com",
            messagingSenderId: "24849732387"
        };
        firebase.initializeApp(config);

        const rootRef = firebase.database().ref();
        const auth = firebase.auth();
        var secondaryApp = firebase.initializeApp(config, "Secondary");

        var btnregistrar = document.getElementById('registrarbtn');
        var actualphoto = document.getElementById('imgestudiante');
        var file = document.getElementById('selectedFile');
        var rutafoto = document.getElementById('rutafoto');
        var nombreprof = document.getElementById('nombreprof');
        var apellidoprof = document.getElementById('apellidoprof');
        var generoprof = document.getElementById('generoprof');
        var fechanac = document.getElementById('fechanac');
        var fechainicio = document.getElementById('fechainicio');
        var cedulaid = document.getElementById('cedulaid');
        var telprof = document.getElementById('telprof');

        var newemail = document.getElementById('newemail');
        var newpass = document.getElementById('newpass');

        var MyKey = '';
        var fotourl = actualphoto.src;
        var NewUserUid = 'TESTuid-asdasdasd';
        var ActualPeriodo = '';
        var CountProfesores = 1;
        var RolesCount = 1;
        var fileFrom;
        var test;

        //Tomar archivo de la foto...
        file.addEventListener('change', function (e) {

            //Get file
            fileFrom = e.target.files[0];
            rutafoto.value = e.target.value;

            firebase.database().ref('CURSOS/' + cursoest.value + '/numero').once('value').then(function (snapshot) {
                if (snapshot != null) {
                    //Asignar el número buscado
                    numeroest = snapshot.val();
                } else {
                }
            });

        });

        //Conteo de profesores
        rootRef.child('PROFESORES').child('count').on('value', function (snapshot) {
            CountProfesores = snapshot.val();
            console.log('Profesores count: ' + CountProfesores);
        });

        //Conteo de roles
        rootRef.child('ROLES').child('count').on('value', function (snapshot) {
            RolesCount = snapshot.val();
            console.log('Roles Count: ' + RolesCount);
        });

        //Conseguir el periodo actual
        rootRef.child('periodoactual').on('value', function (snapshot) {
            ActualPeriodo = snapshot.val();
            console.log(ActualPeriodo);
        });

        function Registrar() {
            btnregistrar.className = 'btn btn-success active disabled';
            newemail.value = newemail.value.toLowerCase();

            //validar que ningún campo esté vacío...
            if (nombreprof.value == "" || apellidoprof.value == "" || generoprof.value == "" || fechanac.value == "" || fechainicio.value == "" ||
                cedulaid.value == "" || telprof.value == "" || newemail.value == "" || newpass.value == "" || rutafoto.value == "") {
                alert('Rellene todos los campos y seleccione la foto del estudiante');
                btnregistrar.className = 'btn btn-success active';
                return;
            } else {
                //Continue
            }

            secondaryApp.auth().createUserWithEmailAndPassword(newemail.value, newpass.value)
                .then(function () {
                })
                .then(function () {
                })
                .catch(function (error) {
                    alert(error.message);
                    btnregistrar.className = 'btn btn-success active';
                });
        }

        secondaryApp.auth().onAuthStateChanged((user) => {
            if (user) {
                NewUserUid = user.uid;
                console.log('Nuevo id de profesor: ' + NewUserUid)
                ProcesoDeRegistro();
                secondaryApp.auth().signOut();
            } else {
            }
        });

        function ProcesoDeRegistro() {

            //Guardar datos en PROFESORES
            firebase.database().ref('PROFESORES/' + NewUserUid).set({
                nombre: nombreprof.value,
                apellido: apellidoprof.value,
                genero: generoprof.value,
                fechanac: fechanac.value,
                fechainicio: fechainicio.value,
                PERIODOS: {
                    [ActualPeriodo]: {
                        MATERIAS: {
                            counter: 0,
                        }
                    },
                },
                cedula: cedulaid.value,
                telefono: telprof.value,
                email: newemail.value,
                uid: NewUserUid,
                foto: 'fotos/' + NewUserUid + '.jpg'
            });

            //Aumentar uno al número
            firebase.database().ref('PROFESORES/').update({
                count: (CountProfesores + 1),
            });

            firebase.database().ref('ROLES/' + NewUserUid).set({
                rol: 'prof'
            });

            //Aumentar uno al número
            firebase.database().ref('ROLES/').update({
                count: (RolesCount + 1),
            });

            console.log(ContadorEstudiantesCurso);
            //Aumentar uno al número
            firebase.database().ref('PERIODOESCOLAR/' + ActualPeriodo + '/CURSOS/' + cursoest.value + '/ESTUDIANTES/').update({
                count: (ContadorEstudiantesCurso + 1),
            });
            console.log(ContadorEstudiantesCurso);

            //Anotar Estudiante en el curso
            test = {
                [numeroest]: {
                    nombre: (nombreprof.value + ' ' + apellidoprof.value),
                    numero: numeroest,
                    uid: NewUserUid
                },
            };
            console.log(test);

            firebase.database().ref('PERIODOESCOLAR/' + ActualPeriodo + '/CURSOS/' + cursoest.value + '/ESTUDIANTES/').update({
                [numeroest]: {
                    nombre: (nombreprof.value + ' ' + apellidoprof.value),
                    numero: numeroest,
                    uid: NewUserUid
                },
            });

            //Upload the profile picture
            //Create storage ref
            var storageref = firebase.storage().ref('fotos/' + NewUserUid + '.jpg');

            //Upload file
            var task = storageref.put(fileFrom);

            task.on('state_changed', function progress(snapshot) {

            }, function error(err) {
                alert('Hubo un error al subir la foto a la nube');
            }, function complete() {
                window.scrollTo(0, 0);
                //window.location.reload();
            })

        }

        function errData(err) {
            console.log('¡Error!');
            console.log(err);
        }

        auth.onAuthStateChanged(firebaseUser => {
            if (firebaseUser) {
                console.log(firebaseUser);
            } else {
                console.log('Sesión Cerrada');
                CerrarSesion();
            }
        });

        function CerrarSesion() {
            firebase.auth().signOut();
            window.location = '../../../index.html';
        }

    </script>
</body>
</html>